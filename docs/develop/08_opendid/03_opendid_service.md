---
id: opendid_service
title: Run OpenDID Service
---


## Configuration

Running the OpenDID service requires a set of configuration as well as a DID. The DID is required to establish a session
with secure connection with the Identity Wallet.
This is done though a keyAgreement key of type `X25519KeyAgreementKey2019` included in the DID Document generated by the
setup container.
Additionally, OpenDID serves a [Well Known DID Configuration](https://identity.foundation/.well-known/resources/did-configuration/)
which is required by the Identity Wallet to ensure that the domain is linked to the specified DID.

### Run Setup Container

Before running the `opendid-setup` container, two environment variables must be set:

1. `SEED` to provide an account with funds (minimum of 3 KILT) for the DID generation.

```bash
export SEED="dont try this seed its completely made up for this nice example"
```
2. `ENDPOINT`

     Set to `"spiritnet"` if the account is on the spiritnet.


    ```bash
    export ENDPOINT="spiritnet"
    ```

     Set to `"peregrine"` if the account is on the peregrine.

    ```bash
    export ENDPOINT="peregrine"
    ```

Then run the setup using:

```bash
docker run --rm -it -e "ENDPOINT=${ENDPOINT}" -v $(pwd):/data docker.io/kiltprotocol/opendid-setup:latest "${SEED}"
```

The command generates a set of new mnemonics and then derives a DID from it and generates multiple files:

1. `config.yaml` The configuration file that is used by the OpenDID service.
1. `did-secrets.json` This file contains all the public and secret keys in the DID Document. You might want to keep a
   secure backup of this file since it contains all the secret keys.
1. `did-document.json` contains the DID Document generated by this setup.

:::danger
Only the `config.yaml` is required to run the OpenDID service. This file includes the provided mnemonic as well as
secret keys and must be protected from unauthorized access.
:::

In the `config.yaml` file you might want to change some settings:

- Set `production` to true, this will only allow secure connections.
- Set the WellKnownDid origin, which should match the origin running the OpenDid service.
- Set the keys used for JWT issuance.
- Clients, including:
    - Their `client_id`s (Default: "exmaple_client").
    - What CTYPEs are required for authentication.
    - The trusted attesters (Default: SocialKYC attester).
    - What `redirect_url`s are accepted.(Default: `http://localhost:1606/callback.html` for the demo project)
    - The `client_secret`, it's optional but recommended, if set it will be required by the `token` endpoint for the
    Authorization Code Flow.

### Example
An example of `config.yaml` file created by the `opendid_setup` container for peregrine:

```json
# OpenDID Config File

# server config
host: 0.0.0.0
port: 3001
basePath: ./login-frontend/dist
production: false
kiltEndpoint: peregrine

# session config
# contains the keyUri, naclSecretKey, naclPublicKey and sessionKey used to communicate with the identity extension
session:
  # key uri of the key agreement key of the verifiers DID
  keyUri: did:kilt:4rsBA7tD5KQ8L9WHjFjYQuHkMkakcfHdC5CaQUcUxyUjDVHA#0x1285e2a18c69bfb7c7f402497adaf5062eb29e35c85461faed403e5c4cc6a9e6
  # nacl secret key of the key agreement key of the verifiers DID
  naclSecretKey: "0xdaa2d564ca316aea1f7f9fd1bcb8180cd55f5bf0084f9ecc818a8bc91275aad2"
  # nacl public key of the key agreement key of the verifiers DID
  naclPublicKey: "0x706ffa25bb26e0be6c7ca14f43029cdced904761979f1cf03b2d7ab25e4ba047"
  # session key used to encrypt the session data, needs to be the same on all instances
  sessionKey: "0x5388fdd8f1caa9cad34ce05e45df91c084cfe15ebb9d8dfb4bbb8ea82bb47f5173c86b6139cdddb494be751700ba661721bf94b6aff65bf666b51524c3f670e7"
  # time in seconds a session lasts as default of 60 minutes
  sessionTtl: 3600

# jwt config
# contains the jwt config for the access and refresh tokens
jwt:
  tokenIssuer: did:kilt:4rsBA7tD5KQ8L9WHjFjYQuHkMkakcfHdC5CaQUcUxyUjDVHA
  accessTokenLifetime: 60
  accessTokenAudience: application
  refreshTokenLifetime: 600
  refreshTokenAudience: authentication
  secretKey: "super-secret-jwt-secret"
  publicKey: "super-secret-jwt-secret"
  algorithm: HS256

# well known DID
wellKnownDid:
  did: did:kilt:4rsBA7tD5KQ8L9WHjFjYQuHkMkakcfHdC5CaQUcUxyUjDVHA
  origin: http://localhost:3001
  keyUri: did:kilt:4rsBA7tD5KQ8L9WHjFjYQuHkMkakcfHdC5CaQUcUxyUjDVHA#0x9d9fc7637b98f00919a7ebb925b729f5141d66222ea7736af7d444b58a6a99d6
  seed: "dentist call educate decorate bag renew success myself fine acoustic rally flush//did//assertion//0"

# client configs
clients:
  example-client:
    # credential requirements
    # contains the credential requirements for the verifiers DID
    # if the user provides ANY of the listed credentials, the login is successful
    # w3n:socialkyc on spiritnet or w3n:attester on peregrine are added as example trustedAttesters for email CType
    requirements:
      - cTypeHash: "0x3291bb126e33b4862d421bfaa1d2f272e6cdfc4f96658988fbcffea8914bd9ac"
        trustedAttesters: ["did:kilt:4pehddkhEanexVTTzWAtrrfo2R7xPnePpuiJLC7shQU894aY"]
        requiredProperties: ["Email"]
    # valid redirect urls for this client
    redirectUrls:
      - http://localhost:1606/callback.html
    clientSecret: "insecure_client_secret"

```

Note that an [Email credential](https://test.ctypehub.galaniprojects.de/ctype/kilt:ctype:0x3291bb126e33b4862d421bfaa1d2f272e6cdfc4f96658988fbcffea8914bd9ac) issued by [attester](https://test.w3n.id/attester) is required.
This credential can be acquired on [test socialKYC](https://test.socialkyc.io/).

## Run the service

Once the `config.yaml` file is adjusted, the OpenDID Service can be run.

1.  Specify the runtime through the environment variable `RUNTIME`:

     Set to `"spiritnet"` for production KILT


    ```bash
    export RUNTIME="spiritnet"
    ```

     Set to `"peregrine"` for the KILT test net.

    ```bash
    export RUNTIME="peregrine"
    ```
2.  Run the `docker.io/kiltprotocol/opendid` docker image .

```bash
docker run -d --rm \
    -v $(pwd)/config.yaml:/app/config.yaml \
    -v $(pwd)/checks:/app/checks \
    -e "RUNTIME=${RUNTIME}" \
    -p 3001:3001 \
    docker.io/kiltprotocol/opendid:latest
```
The login page will run on `http://localhost:3001`.

:::note
An OpenID flow must be integrated in an application for the user to be able to make use of this login page. See
[Integrate OpenDID](/docs/develop/opendid/integrate_opendid).
:::
