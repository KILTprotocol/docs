---
id: setup-node
title: Set Up a Node
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import StartNodeBinary from './_04_start_node_binary.mdx';
import StartNodeDocker from './_04_start_node_docker.mdx';

There are several ways to build and run a collator node.
We show both how to use a Docker image and how to compile the source code directly from [our chain repository](https://github.com/KILTprotocol/kilt-node).

There are currently two different runtimes (i.e., two different parachain environments) that a KILT collator can be part of:

- **Spiritnet**: the official public network, which contains only stable and thoroughly-tested features.
- **Peregrine**: the public test network whose runtime is as close to that of Spiritnet as possible. It can be used to try stuff out before executing them on the production Spiritnet chain, which involves spending tokens that have real monetary value.

Each runtime has its own benchmark measurements.

:::info
The remainder of this guide explaining how to set up and run a collator is mainly for the official **Spiritnet** parachain.
Nevertheless, we recommend to try out the setup on our Peregrine testnet first.
Hence, at each step where it is applicable, we indicate what differs between the Peregrine and Spiritnet configuration for the collator node to join either network.
:::

## Configuration

Running a collator requires a few configuration parameters.
Some of the parameters might appear twice in the command to start the collator, the reason being that a parachain collator actually runs two blockchains.
The parameter that are listed before the `--` are related to the parachain node itself (the KILT blockchain), whereas the parameters following the `--` are related to the relaychain, e.g., Kusama or Polkadot.

Following is a description of some of the parameters that can be set when spinning up a parachain collator node.

### RPC and WS Endpoints

The collator needs session keys that connect it with the collator's KILT account.
These session keys can be generated by calling an RPC endpoint that the collator optionally exposes.
Exposing the RPC endpoint can be done using the following parameters:

```
--rpc-port=9933
--rpc-cors=all
--rpc-methods=unsafe
--unsafe-rpc-external // ONLY for docker based setups
```

Exposing the RPC endpoint of a collator does not imply that it becomes accessible via the PolkadotJS Apps interface, because this requires a Websocket to connect to the node.

By default, the Websocket port used by the node is configured to be `9944`, but it can be changed by specifying a different value with `--ws-port=<ws_port>`.

Connecting from a remote host to either the collator RPC endpoint or WS endpoint requires to explicitly expose those endpoints to the public with the `--rpc-external` and `--ws-external` options.

:::danger

Be aware that it is highly discouraged to publicly expose an RPC endpoint, especially if it allows the execution of unsafe RPC calls!
You should be the only one able to call the RPC endpoint.
For a secure setup, follow the instructions in the previous section about [generating the session keys](./03_session_keys.md).
:::

### WASM runtime execution

A KILT collator should use the `--execution=wasm` parameter for both the relaychain and parachain collation.
The alternative to WASM runtime execution is native runtime execution, which might be faster but can, in some cases, deviate from the WASM execution logic and result in a different state.
When this happens, the collator will crash and will stop producing blocks.
Since the WASM runtime logic is part of the blockchain state itself and hence represents the single source of truth, all collators should execute the WASM version of the runtime logic.

### Specify the right chain spec

The `--chain` parameter decides which blockchain the KILT collator will join.
This parameter must be specified for both the parachain and the relaychain, since both chains are, as a matter of fact, separate blockchains.
The KILT parachain accepts an additional parameter to select the environment to use for the WASM runtime execution.
This can either be `peregrine` or `spiritnet`.

Hence, to start a collator for the Spiritnet network, the parameter would be `--chain=spiritnet`.
Unfortunately, there is no hardcoded chain spec for the Peregrine network such that you have to provide the full path to the chainspec which exists in the [KILT node repository](https://github.com/KILTprotocol/kilt-node/blob/develop/dev-specs/kilt-parachain/peregrine-kilt.json) and [docker image](https://hub.docker.com/r/kiltprotocol/kilt-node/tags) `--chain=/node/dev-specs/kilt-parachain/peregrine-kilt.json`.

### Where are all the files stored?

The `--base-path` parameter specifies where all the persistent files must be stored.
By default, the session keys will also be stored in the *base path*, but we recommend to separate them from the other files.
This makes sure that the keyfiles are not accidentally lost or published when the blockchain database is either backed up or restored.
You can configure where to store the session keys using the `--keystore-path` option.
Since the collator will collate only for the parachain, there is no need to add this to the relaychain part of the command.

### Storage Root Error

Due to an issue in the caching implementation in Substrate, it is recommended to reduce the cache size.
Otherwise the node might get blacklisted by other peers and ultimately disconnected from the p2p network.
This leads to a longer block time and a loss of rewards for the collator.

Throughout this guide, the option `--state-cache-size=1` was added to reduce the cache size to 1 Byte.

## Obtain the node executable

<Tabs
  groupId="exec-strategy"
  defaultValue="Docker"
  values={[
    {label: 'Binary', value: 'Binary'},
    {label: 'Docker', value: 'Docker'},
  ]}>
<TabItem value="Binary">

In order to build the KILT collator executable, you need to have a [nightly version of Rust](https://www.rust-lang.org/tools/install) and the `wasm32-unknown-unknown` for this toolchain installed.
We recommend to align your nightly version with the one used in the [KILT node repository](https://github.com/KILTprotocol/kilt-node) by executing the [init script](https://github.com/KILTprotocol/kilt-node/blob/develop/scripts/init.sh).
After cloning the repository, you can build the executable by running the `build` command below from the root directory.

```bash
# Clone the repository
git clone https://github.com/KILTprotocol/kilt-node.git
# Check out master branch
git checkout master
# Set up the build environment by installing the Rust compiler.
./scripts/init.sh
# Build the executable from source enabling all the optimizations with --release.
cargo build --release -p kilt-parachain
```

:::info
You must not use the default `develop` branch to build the executable.
Instead, the [latest release](https://github.com/KILTprotocol/kilt-node/releases) from `master` should be used.
:::

The compiled executable can be found in `./target/release/kilt-parachain` after the build process completes successfully.

</TabItem>
<TabItem value="Docker">

Simply pull the [latest docker image](https://hub.docker.com/r/kiltprotocol/kilt-node/tags):

```bash
docker pull kiltprotocol/kilt-node:latest
```

</TabItem>
</Tabs>

## Start the node

<Tabs
  groupId="exec-strategy"
  defaultValue="Docker"
  values={[
    {label: 'Binary', value: 'Binary'},
    {label: 'Docker', value: 'Docker'},
  ]}>
<TabItem value="Binary">
<StartNodeBinary />

In either case, if the node needs to be reachable via PolkadotJS Apps, the `--ws-external` flag must be added to the collator options, before the `--` divider.

</TabItem>
<TabItem value="Docker">
<StartNodeDocker />

In either case, if the node needs to be reachable via PolkadotJS Apps, the `--ws-external` flag must be added to the collator options, before the `--` divider, and the WS port must be exposed from the container with an additional `-p 9944:9944` parameter.

The docker command will map the database files for the relay and parachain as well as the keystore directory to `~/data` on the host system using the flag `-v $HOME/data:/data`.
That way the blockchain database files are not lost when and if the Docker container is removed and can be mounted back on next containers.

The docker container runs as an user with id 1000 and will try to access the mapped volume and the files it contains.
If the files are not owned by a user with id 1000, this will result in an error.
If that is the case, run `sudo chown -R 1000:1000 $HOME/data` to give the container access.


</TabItem>
</Tabs>

## Sync the blockchain state

Before a collator can author blocks, the node needs to fully sync up with both the parachain and the relaychain.
Depending on the size of the blockchain states, it may take a number of hours to few days for the node to catch up.
More details can be found on the [Polkadot network docs](https://wiki.polkadot.network/docs/maintain-guides-how-to-validate-kusama#synchronize-chain-data).

:::note Example of node sync:
```Example of node sync
2021-06-17 02:34:34 üîç Discovered new external address for our node: /ip4/100.102.231.64/tcp/30333/ws/p2p/12D3KooWLE7ivpuXJQpFVP4fuuutAqEsk8nrNEpuR3tddqnXgLPB
2021-06-17 02:34:36 ‚öôÔ∏è  Syncing 409.2 bps, target=#8062689 (5 peers), best: #3477 (0x63ad‚Ä¶e046), finalized #3072 (0x0e4c‚Ä¶f587), ‚¨á 153.2kiB/s ‚¨Ü 12.9kiB/s
2021-06-17 02:34:37 üîç Discovered new external address for our node: /ip4/100.111.175.0/tcp/30333/ws/p2p/12D3KooWLE7ivpuXJQpFVP4fuuutAqEsk8nrNEpuR3tddqnXgLPB
2021-06-17 02:34:38 üîç Discovered new external address for our node: /ip4/100.100.176.0/tcp/30333/ws/p2p/12D3KooWLE7ivpuXJQpFVP4fuuutAqEsk8nrNEpuR3tddqnXgLPB
2021-06-17 02:34:41 ‚öôÔ∏è  Syncing 386.2 bps, target=#8062690 (7 peers), best: #5409 (0x1d76‚Ä¶8c3d), finalized #5121 (0x8ad1‚Ä¶b6dc), ‚¨á 96.1kiB/s ‚¨Ü 10.9kiB/s
2021-06-17 02:34:46 ‚öôÔ∏è  Syncing 394.8 bps, target=#8062691 (11 peers), best: #7383 (0x0689‚Ä¶6f1e), finalized #7168 (0x72a9‚Ä¶8d8c), ‚¨á 352.9kiB/s ‚¨Ü 5.1kiB/s
2021-06-17 02:34:51 ‚öôÔ∏è  Syncing 347.0 bps, target=#8062692 (12 peers), best: #9118 (0x66fc‚Ä¶cce3), finalized #8704 (0x14c9‚Ä¶705e), ‚¨á 62.7kiB/s ‚¨Ü 1.7kiB/s
```
:::